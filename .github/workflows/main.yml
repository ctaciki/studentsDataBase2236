CXX = g++
CXXFLAGS = -Wall -Wextra -std=c++11
COVERAGE_FLAGS = -fprofile-arcs -ftest-coverage
TEST_FLAGS = -lgtest -lgtest_main -lpthread

SRC = main.cpp
OBJ = $(SRC:.cpp=.o)
TEST_OBJ = $(SRC:.cpp=_test.o)

TARGET = program.out
TEST_TARGET = test_program.out

all: $(TARGET)

$(TARGET): $(OBJ)
	$(CXX) $(CXXFLAGS) -o $@ $^

test: $(TEST_TARGET)

$(TEST_TARGET): $(SRC)
	$(CXX) $(CXXFLAGS) $(COVERAGE_FLAGS) -o $@ $^ $(TEST_FLAGS)

coverage: test
	./$(TEST_TARGET) --run-tests
	gcov $(SRC)
	lcov --capture --directory . --output-file coverage.info
	genhtml coverage.info --output-directory coverage_report

clean:
	rm -f $(TARGET) $(TEST_TARGET) *.o *.gcno *.gcda *.gcov coverage.info
	rm -rf coverage_report

.PHONY: all test coverage clean
